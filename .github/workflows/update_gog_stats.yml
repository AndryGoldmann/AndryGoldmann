name: Update GOG Stats

on:
  push:
    paths:
      - 'my_gog_games.csv' # Triggers only when this file changes
  workflow_dispatch: # Allows you to run it manually

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install pandas # We use pandas to easily read the CSV

      - name: Run script to parse CSV and create text chunk
        run: |
          import pandas as pd

          # Read the CSV
          try:
              df = pd.read_csv('my_gog_games.csv')
          except FileNotFoundError:
              print("CSV file not found.")
              exit()

          # Filter for games with playtime, sort, and take top 5
          df_played = df[df['playtime'] > 0].copy()
          df_played['playtime_hours'] = (df_played['playtime'] / 60).round(1)
          top_5 = df_played.sort_values(by='playtime', ascending=False).head(5)

          # Generate the markdown text
          markdown_text = ""
          for _, game in top_5.iterrows():
              markdown_text += f"* **{game['title']}**: {game['playtime_hours']} hours\n"

          if not markdown_text:
              markdown_text = "No playtime recorded yet!"

          # Save the markdown text to a file
          with open('gog_stats.md', 'w') as f:
              f.write(markdown_text)
        shell: python

      - name: Update README.md
        uses: EndBug/readme-chunk-action@v2
        with:
          target_file: 'README.md'
          chunk_file: 'gog_stats.md'
          token: ${{ secrets.GITHUB_TOKEN }}
          placeholder: 'GOG_STATS' # Matches the placeholder
